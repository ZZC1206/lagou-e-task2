**环境准备**

​		把从 **git** 拉去下来的项目用 **vs code** 打开，在根目录 **cmd** 执行命令，安装项目依赖的包

```cmd
npm install
```



## 构建项目准备

​		使用 **Gulp** 自动化构建工具，gulp官网：https://www.gulpjs.com.cn/docs/getting-started/quick-start/



### 1. 安装 gulp 命令行工具

```cmd
npm install --global gulp-cli
```

### 2. 安装 gulp 插件

```cmd
npm i gulp -save-dev
```

### 3. 创建gulp入口

​		在项目的根目录下创建 **gulpfile.js** 文件(拉去下来的项目已经有可以忽略这一步)



## 样式编译

​		首先通过gulp.src()方法获取到我们想要处理的文件流，然后把文件流通过pipe方法导入到gulp的插件中，最后把经过插件处理后的流再通过pipe方法导入到gulp.dest()中，gulp.dest()方法则把流中的内容写入到文件中

### 1. 实现文件的转换

```js
const { src, dest } = require('gulp')

const style = () => {
    return src('src/assets/styles/*.scss')
        .pipe(dest('dist'))
}

module.exports = {
    style
}
```

​		这里是把 **src/assets/styles** 下所有 **.scss** 的文件读取出来，写入到根目录下的 **dist** 文件里，执行命令测试

```cmd
gulp style
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> yarn gulp style
yarn run v1.22.10
$ F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\node_modules\.bin\gulp style
[21:01:03] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[21:01:03] Starting 'style'...
[21:01:03] Finished 'style' after 64 ms
Done in 1.27s.
```

​		这时候会看到根目录下生成一个 **dist** 文件夹，里面有三个 **.scss** 的文件，文件里面的内容分别更 **src/assets/styles** 目录下的 **.scss** 相同。



### 2. 按照原本的路径来转换

​		上面生成的 **.scss** 文件不是直接在目录里，而是在 **src/assets/styles** 文件夹里，这里可以通过 **src** 的一个选项参数的来指定转换路径来实现。

```js
const { src, dest } = require('gulp')

const style = () => {
    return src('src/assets/styles/*.scss', { base: 'src' })
        .pipe(dest('dist'))
}

module.exports = {
    style
}
```

​		把 **dist** 文件删除，执行命令进行测试

```cmd
gulp style
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> yarn gulp style
yarn run v1.22.10
$ F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\node_modules\.bin\gulp style
[21:06:53] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[21:06:53] Starting 'style'...
[21:06:53] Finished 'style' after 46 ms
Done in 1.15s.
```

​		这时候会看到生成的 **.scss** 文件在 **dist\assets\styles\_icons.scss** 文件的夹里



### 3. .scss 转换成 .css 文件

​		因为 **.scss** 文件是生产环境不能直接识别运行的，所以需要把他们转换成 **.css** 文件。

#### 1. 安装 gulp-scss 插件

```cmd
npm i gulp-sass@4.0.2 -save-dev
```

#### 2. 安装 node-sass

​		**gulp-scss** 需要有 **node-sass** 支持

```cmd
npm i node-sass -save-dev
```

#### 3. 实现 .scss 文件的转换

```js
const { src, dest } = require('gulp')
const sass = require('gulp-sass') // 导入刚刚安装 gulp-sass 插件

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

module.exports = {
  style
}
```

​		把 **dist** 文件删除，执行命令进行测试

```cmd
gulp style
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp style
[22:02:27] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[22:02:27] Starting 'style'...
[22:02:27] Finished 'style' after 4
```

​		这时候看到 **.scss** 实现了转换，并且 **css** 文件的 **}** 按照完全展开的格式转换，但是 **_xxx.scss** 文件是被忽略转换的。



## 脚本编译

### 1. 安装包依赖

​		因为 **js** 程序编写会用到 **ES6+** 的特性，需要用到 **babel** 来转换。

```cmd
npm i gulp-babel @babel/core @babel/preset-env -save-dev
```

### 2. 实现文件转换

```js
const { src, dest } = require('gulp')
const sass = require('gulp-sass') // 导入 gulp-sass 插件
const babel = require('gulp-babel') // 导入刚刚安装 gulp-babel 插件

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

module.exports = {
  style,
  script
}
```

​		执行命令进行测试

```cmd
gulp script
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp script
[22:19:06] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[22:19:06] Starting 'script'...
[22:19:07] Finished 'script' after 1
```

​		这时候会看到 **dist** 文件夹，里面有 **scripts** 文件夹对应的 **.js** 文件。



## 页面模板编译

### 1. 安装包依赖

```cmd
npm i gulp-swig -save-dev
```



### 2. 按照原本的路径来转换

```js
const { src, dest } = require('gulp')
const sass = require('gulp-sass') // 导入 gulp-sass 插件
const babel = require('gulp-babel') // 导入安装 gulp-babel 插件
const swig = require('gulp-swig') // 导入刚刚安装 gulp-swig 插件

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(swig())
    .pipe(dest('dist'))
}

module.exports = {
  style,
  script,
  page
}
```

​		执行命令进行测试

```cmd
gulp page
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp page
[22:28:27] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[22:28:27] Starting 'page'...
[22:28:27] Finished 'page' after 63
```

​		这时候会看到 **dist** 文件夹，里面有对应的 **.html** 文件，但是会 **{{pkg.name}}** 看到模板数据没有被转换成功。



### 3. 模板中引入数据

```js
const { src, dest } = require('gulp')
const sass = require('gulp-sass') // 导入 gulp-sass 插件
const babel = require('gulp-babel') // 导入安装 gulp-babel 插件
const swig = require('gulp-swig') // 导入刚刚安装 gulp-swig 插件

const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(swig({ data }))
    .pipe(dest('dist'))
}

module.exports = {
  style,
  script,
  page
}

```

​	执行命令进行测试

```cmd
gulp page
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp page
[22:39:48] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[22:39:48] Starting 'page'...
[22:39:48] Finished 'page' after 55
```

​		这时候会看到 **dist** 文件夹，里面有对应的 **.html** 文件，看到模板数据也被转换成功。



## 图片及文字文件转换

### 1. 安装插件

```cmd
npm i gulp-imagemin -save-dev
```



### 2. 创建 img 任务

```js
const { src, dest } = require('gulp')
const sass = require('gulp-sass') // 导入 gulp-sass 插件
const babel = require('gulp-babel') // 导入安装 gulp-babel 插件
const swig = require('gulp-swig') // 导入安装 gulp-swig 插件
const imagemin = require('gulp-imagemin') // 导入刚刚安安装 gulp-imagemin 插件

const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(swig({ data }))
    .pipe(dest('dist'))
}

const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(imagemin())
    .pipe(dest('dist'))
}

module.exports = {
  style,
  script,
  page,
  image
}
```

​	执行命令进行测试

```cmd
gulp image
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp image
[22:46:01] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[22:46:01] Starting 'image'...
[22:46:03] gulp-imagemin: Minified 2 images (saved 23.1 kB - 26.7%)
[22:46:03] Finished 'image' after 1
```

​		这时候会看到图片的压缩信息，证明图片已经成功被转换了，这里压缩是把图片里面多余的二进制信息剔除掉。



### 3. 创建 font 任务

```js
const { src, dest } = require('gulp')
const sass = require('gulp-sass') // 导入 gulp-sass 插件
const babel = require('gulp-babel') // 导入安装 gulp-babel 插件
const swig = require('gulp-swig') // 导入安装 gulp-swig 插件
const imagemin = require('gulp-imagemin') // 导入刚刚安安装 gulp-imagemin 插件

const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(swig({ data }))
    .pipe(dest('dist'))
}

const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(imagemin())
    .pipe(dest('dist'))
}

const font = () => {
  return src('src/assets/fonts/**', { base: 'src' })
    .pipe(imagemin())
    .pipe(dest('dist'))
}

module.exports = {
  style,
  script,
  page,
  image,
  font
}
```

​	执行命令进行测试

```cmd
gulp font
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp font
[22:50:19] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[22:50:19] Starting 'font'...
[22:50:20] gulp-imagemin: Minified 1 image (saved 693 B - 6%)
[22:50:20] Finished 'font' after 1.06 s
```

​		这时候会看到文字的压缩信息。



## 其他普通文件转换

### 1. 实现文件的转换

```js
// 实现这个项目的构建任务
const { src, dest, parallel } = require('gulp')
const sass = require('gulp-sass') // 导入 gulp-sass 插件
const babel = require('gulp-babel') // 导入安装 gulp-babel 插件
const swig = require('gulp-swig') // 导入安装 gulp-swig 插件
const imagemin = require('gulp-imagemin') // 导入刚刚安安装 gulp-imagemin 插件

const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(swig({ data }))
    .pipe(dest('dist'))
}

const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(imagemin())
    .pipe(dest('dist'))
}

const font = () => {
  return src('src/assets/fonts/**', { base: 'src' })
    .pipe(imagemin())
    .pipe(dest('dist'))
}

const extra = () => {
  return src('public/**', { base: 'public' })
    .pipe(dest('dist'))
}

// parallel 同时执行
const compile = parallel(style, script, page, image, font)

const build = parallel(compile, extra)

module.exports = {
  compile,
  build
}
```

执行命令进行测试

```cmd
 gulp build
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate>  gulp build
[23:01:44] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[23:01:44] Starting 'build'...
[23:01:44] Starting 'extra'...
[23:01:44] Starting 'style'...
[23:01:44] Starting 'script'...
[23:01:44] Starting 'page'...
[23:01:44] Starting 'image'...
[23:01:44] Starting 'font'...
[23:01:46] Finished 'style' after 2.71 s
[23:01:47] Finished 'extra' after 2.88 s
[23:01:47] Finished 'script' after 2.89 s
[23:01:47] Finished 'page' after 2.89 s
[23:01:47] gulp-imagemin: Minified 1 image (saved 693 B - 6%)
[23:01:47] Finished 'font' after 2.9 s
[23:01:47] gulp-imagemin: Minified 2 images (saved 23.1 kB - 26.7%)
[23:01:47] Finished 'image' after 3.31 s
[23:01:47] Finished 'build' after 3
```

​		这时候会看到构建任务会同时执行，执行完毕后在 **dist** 文件下有 **public** 目录下的文件。

### 

## 文件清除

​		由在在开发阶段，实现功能的代码需要迭代式地调试开发，之前为了看到测试效果，需要手动把 **dist** 文件删除，这样在开发中有点不友好。可以使用插件来帮忙完成文件的删除。

### 1. 安装插件

```cmd
npm i del -save-dev
```



### 2. 创建 del 任务

```js
// 实现这个项目的构建任务
const { src, dest, parallel, series } = require('gulp')

const sass = require('gulp-sass') // 导入 gulp-sass 插件
const babel = require('gulp-babel') // 导入安装 gulp-babel 插件
const swig = require('gulp-swig') // 导入安装 gulp-swig 插件
const imagemin = require('gulp-imagemin') // 导入安装 gulp-imagemin 插件

const del = require('del') // 导入 gulp-sass 插件

const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}

const clean = () => {
  return del(['dist'])
}


const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(swig({ data }))
    .pipe(dest('dist'))
}

const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(imagemin())
    .pipe(dest('dist'))
}

const font = () => {
  return src('src/assets/fonts/**', { base: 'src' })
    .pipe(imagemin())
    .pipe(dest('dist'))
}

const extra = () => {
  return src('public/**', { base: 'public' })
    .pipe(dest('dist'))
}

// parallel 同时执行
const compile = parallel(style, script, page, image, font)

// series 穿行执行
const build = series(clean, parallel(compile, extra))

module.exports = {
  compile,
  build
}
```

执行命令进行测试

```cmd
 gulp build
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate>  gulp build
[23:10:51] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[23:10:51] Starting 'build'...
[23:10:51] Starting 'clean'...
[23:10:51] Finished 'clean' after 27 ms
[23:10:51] Starting 'extra'...
[23:10:51] Starting 'style'...
[23:10:51] Starting 'script'...
[23:10:51] Starting 'page'...
[23:10:51] Starting 'image'...
[23:10:51] Starting 'font'...
[23:10:53] Finished 'style' after 2.28 s
[23:10:53] Finished 'extra' after 2.28 s
[23:10:53] Finished 'script' after 2.46 s
[23:10:53] Finished 'page' after 2.46 s
[23:10:53] gulp-imagemin: Minified 1 image (saved 693 B - 6%)
[23:10:53] Finished 'font' after 2.48 s
[23:10:54] gulp-imagemin: Minified 2 images (saved 23.1 kB - 26.7%)
[23:10:54] Finished 'image' after 2.9 s
[23:10:54] Finished 'build' after 2
```

​		这时候会看到先执行 **clean** 构建任务，然后再去同时执行其他任务。



## 自动加载插件

​		由于对不同的文件进行构建，就需要不同的插件来完成，如果随着构建的任务增多，**require** 的插件代码越来越多，不利于后面的管理，这时候需要自动加载插件来进行插件加载。

### 1. 安装依赖包

```cmd
npm i gulp-load-plugins -save-dev
```



### 2. 使用插件

​	右键 变量名字 ---> 重命名符号 （快捷键：F2）

```js
// 实现这个项目的构建任务
const { src, dest, parallel, series } = require('gulp')

const loadPlugins = require('gulp-load-plugins') // 导入插件管理工具
const plugins = loadPlugins()

const del = require('del') // 导入 gulp-sass 插件

const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}

const clean = () => {
  return del(['dist'])
}


const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(plugins.sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(plugins.babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(plugins.swig({ data }))
    .pipe(dest('dist'))
}

const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const font = () => {
  return src('src/assets/fonts/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const extra = () => {
  return src('public/**', { base: 'public' })
    .pipe(dest('dist'))
}

// parallel 同时执行
const compile = parallel(style, script, page, image, font)

// series 穿行执行
const build = series(clean, parallel(compile, extra))

module.exports = {
  compile,
  build
}
```

​		执行命令进行测试

```cmd
gulp build
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate>  gulp build
[23:20:29] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[23:20:29] Starting 'build'...
[23:20:29] Starting 'clean'...
[23:20:29] Finished 'clean' after 24 ms
[23:20:29] Starting 'extra'...
[23:20:29] Starting 'style'...
[23:20:29] Starting 'script'...
[23:20:29] Starting 'page'...
[23:20:29] Starting 'image'...
[23:20:29] Starting 'font'...
[23:20:33] Finished 'style' after 3.26 s
[23:20:33] Finished 'extra' after 3.46 s
[23:20:33] Finished 'script' after 3.46 s
[23:20:33] Finished 'page' after 3.46 s
[23:20:33] gulp-imagemin: Minified 1 image (saved 693 B - 6%)
[23:20:33] Finished 'font' after 3.47 s
[23:20:33] gulp-imagemin: Minified 2 images (saved 23.1 kB - 26.7%)
[23:20:33] Finished 'image' after 3.91 s
[23:20:33] Finished 'build' after
```

​		这时候会看到先执行 **clean** 构建任务，然后再去同时执行其他任务，成功执行证明自动加载插件起作用了。



## 服务器开发

​		当网页开发完成后需要在浏览器中进行预览调试等，这时需要热更新开发服务器。

### 1. 安装依赖包

```cmd
npm i browser-sync -save-dev
```



### 2. 创建 serve 任务

```js
// 实现这个项目的构建任务
const { src, dest, parallel, series } = require('gulp')

const loadPlugins = require('gulp-load-plugins') // 导入插件自动加载工具
const plugins = loadPlugins()

const browserSync = require('browser-sync') // 导入 browser-sync 插件
const bs = browserSync.create()

const del = require('del') // 导入 del 插件

const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}

const clean = () => {
  return del(['dist'])
}

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(plugins.sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(plugins.babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(plugins.swig({ data }))
    .pipe(dest('dist'))
}

const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const font = () => {
  return src('src/assets/fonts/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const extra = () => {
  return src('public/**', { base: 'public' })
    .pipe(dest('dist'))
}

const serve = () => {
  bs.init({
    server: {
      baseDir: 'dist',
    }
  })
}

// parallel 同时执行
const compile = parallel(style, script, page, image, font)

// series 穿行执行
const build = series(clean, parallel(compile, extra))

module.exports = {
  compile,
  build,
  serve
}
```

​		执行命令进行测试

```cmd
gulp serve
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp serve
[23:30:32] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[23:30:32] Starting 'serve'...
[Browsersync] Access URLs:
 -------------------------------------
       Local: http://localhost:3000
    External: http://192.168.31.9:3000
 -------------------------------------
          UI: http://localhost:3001
 UI External: http://localhost:3001
 -------------------------------------
[Browsersync] Serving files from: 
_
```

​		这时候会自动打开浏览器预览，但是样式等资源没加载进来。



### 3. 修改 server 任务

​		进行跟多的任务配置

```js
...

const serve = () => {
    bs.init({
        server: {
            baseDir: 'dist',
            routes: {
                '/node_modules': 'node_modules'
            }
        }
    })
}

...
```

​		执行命令进行测试

```cmd
gulp serve
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp serve
[23:33:26] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[23:33:26] Starting 'serve'...
[Browsersync] Access URLs:
 -------------------------------------
       Local: http://localhost:2080
    External: http://192.168.31.9:2080
 -------------------------------------
          UI: http://localhost:3001
 UI External: http://localhost:3001
 -------------------------------------
[Browsersync] Serving files from: d
_
```

​		会自动打开浏览器预览，但是页面已经有样式了。



## 监视文件变化

​		实现代码修改后自动编译，浏览器自动更新

### 1. 实现所有产生构建任务监听

```js
// 实现这个项目的构建任务
const { src, dest, parallel, series, watch } = require('gulp')

const loadPlugins = require('gulp-load-plugins') // 导入插件自动加载工具
const plugins = loadPlugins()

const browserSync = require('browser-sync') // 导入 browser-sync 插件
const bs = browserSync.create()

const del = require('del') // 导入 del 插件

const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}

const clean = () => {
  return del(['dist'])
}

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(plugins.sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(plugins.babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(plugins.swig({ data }))
    .pipe(dest('dist'))
}

const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const font = () => {
  return src('src/assets/fonts/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const extra = () => {
  return src('public/**', { base: 'public' })
    .pipe(dest('dist'))
}

const serve = () => {
  // 监听的文件路径 文件发生变化后需要执行的构建任务
  watch('src/assets/styles/*.scss', style)
  watch('src/assets/scripts/*.js', script)
  watch('src/*.html', page)
  watch('src/assets/images/**', image)
  watch('src/assets/fonts/**', font)
  watch('public/**', extra)

  bs.init({
    notify: false, // 关掉提示
    port: 2080, // 设置端口
    // open: false, // 取消自动打开浏览器
    files: 'dist/**', // 需要监听的文件
    server: {
      baseDir: 'dist',
      routes: {
        '/node_modules': 'node_modules'
      }
    }
  })
}

// parallel 同时执行
const compile = parallel(style, script, page, image, font)

// series 穿行执行
const build = series(clean, parallel(compile, extra))

module.exports = {
  compile,
  build,
  serve
}
```

​		执行命令进行测试

```cmd
gulp serve
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp serve
[23:41:48] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[23:41:48] Starting 'serve'...
[Browsersync] Access URLs:
 -------------------------------------
       Local: http://localhost:2080
    External: http://192.168.31.9:2080
 -------------------------------------
          UI: http://localhost:3001
 UI External: http://localhost:3001
 -------------------------------------
[Browsersync] Serving files from: dist
[Browsersync] Watching files...
[23:42:36] Starting 'style'...
[23:42:36] Finished 'style' after 326 ms
[Browsersync] File event [change] : dist\assets\styles\main.css
_
```

​		会自动打开浏览器预览，这时候把**src\assets\styles\_variables.scss** 的 **$jumbotron-bg: #fff;** 修改成 **$jumbotron-bg: #f00;** 浏览器会自动刷新页面。



### 2. 优化监听减少开销

​	图片资源监听 ***image*** 、***font***、 ***extra*** 不需要时刻 **watch**

```js
// 实现这个项目的构建任务
const { src, dest, parallel, series, watch } = require('gulp')

const loadPlugins = require('gulp-load-plugins') // 导入插件自动加载工具
const plugins = loadPlugins()

const browserSync = require('browser-sync') // 导入 browser-sync 插件
const bs = browserSync.create()

const del = require('del') // 导入 del 插件

const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}

const clean = () => {
  return del(['dist'])
}

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(plugins.sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(plugins.babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(plugins.swig({ data }))
    .pipe(dest('dist'))
}

const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const font = () => {
  return src('src/assets/fonts/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const extra = () => {
  return src('public/**', { base: 'public' })
    .pipe(dest('dist'))
}

const serve = () => {
  // 监听的文件路径 文件发生变化后需要执行的构建任务
  watch('src/assets/styles/*.scss', style)
  watch('src/assets/scripts/*.js', script)
  watch('src/*.html', page)
  watch([
    'src/assets/images/**',
    'src/assets/fonts/**',
    'public/**'
  ], bs.reload) // 监听文件变化，重新发送请求

  bs.init({
    notify: false, // 关掉提示
    port: 3080, // 设置端口
    // open: false, // 取消自动打开浏览器
    files: 'dist/**', // 需要监听的文件
    server: {
      baseDir: ['dist', 'src', 'public'], // 会根据文件夹依次寻找文件
      routes: {
        '/node_modules': 'node_modules'
      }
    }
  })
}
 
// parallel 同时执行 series 穿行执行
const compile = parallel(style, script, page)

// 上线前执行的任务
const build = series(clean, parallel(compile, image, font, extra))

// 开发阶段执行的任务
const develop = series(compile, serve)

module.exports = {
  clean,
  compile,
  build,
  develop
}
```

​		执行命令进行测试

```cmd
gulp develop
```



## 处理文件的引用关系

### 1. 安装依赖包

```cmd
npm i gulp-useref -save-dev
```



### 2. 创建 useref 任务

```js
// 实现这个项目的构建任务
const { src, dest, parallel, series, watch } = require('gulp')

const loadPlugins = require('gulp-load-plugins') // 导入插件自动加载工具
const plugins = loadPlugins()

const browserSync = require('browser-sync') // 导入 browser-sync 插件
const bs = browserSync.create()

const del = require('del') // 导入 del 插件

const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}

const clean = () => {
  return del(['dist'])
}

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(plugins.sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('dist'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(plugins.babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(plugins.swig({ data }))
    .pipe(dest('dist'))
}

const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const font = () => {
  return src('src/assets/fonts/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const extra = () => {
  return src('public/**', { base: 'public' })
    .pipe(dest('dist'))
}

const serve = () => {
  // 监听的文件路径 文件发生变化后需要执行的构建任务
  watch('src/assets/styles/*.scss', style)
  watch('src/assets/scripts/*.js', script)
  watch('src/*.html', page)
  watch([
    'src/assets/images/**',
    'src/assets/fonts/**',
    'public/**'
  ], bs.reload) // 监听文件变化，重新发送请求

  bs.init({
    notify: false, // 关掉提示
    port: 3080, // 设置端口
    // open: false, // 取消自动打开浏览器
    // files: 'dist/**', // 需要监听的文件
    server: {
      baseDir: ['dist', 'src', 'public'], // 会根据文件夹依次寻找文件
      routes: {
        '/node_modules': 'node_modules'
      }
    }
  })
}

const useref = () => {
  return src('dist/*.html', { base: 'dist' })
    .pipe(plugins.useref({ searchPath: ['dist', '.'] }))
    .pipe(dest('dist'))
}

// parallel 同时执行
// series 穿行执行
const compile = parallel(style, script, page)

// 上线前执行的任务
const build = series(clean, parallel(compile, image, font, extra))

// 开发阶段执行的任务
const develop = series(compile, serve)

module.exports = {
  clean,
  compile,
  build,
  develop,
  useref
}

```

​		执行命令进行测试

```cmd
gulp clean

gulp compile

gulp useref
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp clean
[00:01:58] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[00:01:58] Starting 'clean'...
[00:01:58] Finished 'clean' after 23 ms
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp compile
[00:02:17] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[00:02:17] Starting 'compile'...
[00:02:17] Starting 'style'...
[00:02:17] Starting 'script'...
[00:02:17] Starting 'page'...
[00:02:19] Finished 'script' after 1.66 s
[00:02:19] Finished 'page' after 1.67 s
[00:02:19] Finished 'style' after 1.67 s
[00:02:19] Finished 'compile' after 1.68 s
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp useref
[00:02:42] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[00:02:42] Starting 'useref'...
[00:02:42] Finished 'useref' after 306 ms
```

​		这时候会看到一用 **.html** 的文件引用关系的路径都指向 **dist** 目录下相关的文件。



## 文件压缩处理

​		部署到生产环境运行的文件尽可能的小，所以有必要对 **.html** **.css** **.js** 文件进行压缩处理。

### 1. 安装依赖包

```cmd
npm i gulp-htmlmin gulp-uglify gulp-clean-css -save-dev
```

由于需要判断 文件的类型需要用到判断插件

```cmd
npm i gulp-if -save-dev
```

### 2. 增加文件压缩功能

```js
···

const useref = () => {
  return src('dist/*.html', { base: 'dist' })
    .pipe(plugins.useref({ searchPath: ['dist', '.'] }))
    .pipe(plugins.if(/\.js$/, plugins.uglify()))
    .pipe(plugins.if(/\.css$/, plugins.cleanCss()))
    .pipe(plugins.if(/\.html$/, plugins.htmlmin({
            collapseWhitespace: true, // 压缩html里面的空白符
            minifyCSS: true, // 压缩html里面的style标签内容
            minifyJS: true // 压缩html里面的script标签内容
        })))
    .pipe(dest('dist'))
}

···
```

测试🌰

```cmd
yarn gulp clean

yarn gulp compile

yarn gulp useref
```

​		这时会看到 **dist** 目录下相关的文件已经被压缩了。



## 重新规划整个构建过程

​		执行压缩文件任务后，有时候你会看到，有些文件是空白的，由于对相同文件的文件流读取和写入会造成一些冲突，所以需要把构建完成后的文件放在临时文件目录中，再进行压缩处理。

```js
// 实现这个项目的构建任务
const { src, dest, parallel, series, watch } = require('gulp')

const loadPlugins = require('gulp-load-plugins') // 导入插件自动加载工具
const plugins = loadPlugins()

const browserSync = require('browser-sync') // 导入 browser-sync 插件
const bs = browserSync.create()

const del = require('del') // 导入 del 插件
const ftp = require('gulp-sftp')

const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}

const clean = () => {
  return del(['dist', 'temp'])
}

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(plugins.sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('temp'))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(plugins.babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('temp'))
}

const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(plugins.swig({ data }))
    .pipe(dest('temp'))
}

const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const font = () => {
  return src('src/assets/fonts/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const extra = () => {
  return src('public/**', { base: 'public' })
    .pipe(dest('dist'))
}

const serve = () => {
  // 监听的文件路径 文件发生变化后需要执行的构建任务
  watch('src/assets/styles/*.scss', style)
  watch('src/assets/scripts/*.js', script)
  watch('src/*.html', page)
  watch([
    'src/assets/images/**',
    'src/assets/fonts/**',
    'public/**'
  ], bs.reload) // 监听文件变化，重新发送请求

  bs.init({
    notify: false, // 关掉提示
    port: 2080, // 设置端口
    // open: false, // 取消自动打开浏览器
    // files: 'dist/**', // 需要监听的文件
    server: {
      baseDir: ['temp', 'src', 'public'], // 会根据文件夹依次寻找文件
      routes: {
        '/node_modules': 'node_modules'
      }
    }
  })
}

const lint = () => {
  return src('dist/*.html', { base: 'temp' })
    .pipe(plugins.useref({ searchPath: ['temp', '.'] }))
    .pipe(plugins.if(/\.js$/, plugins.uglify()))
    .pipe(plugins.if(/\.css$/, plugins.cleanCss()))
    .pipe(plugins.if(/\.html$/, plugins.htmlmin({
      collapseWhitespace: true, // 压缩html里面的空白符
      minifyCSS: true, // 压缩html里面的style标签内容
      minifyJS: true // 压缩html里面的script标签内容
    })))
    .pipe(dest('dist'))
}

// parallel 同时执行
// series 穿行执行
const compile = parallel(style, script, page)

// 上线前执行的任务
const build = series(clean, parallel(compile, image, font, extra))

// 开发阶段执行的任务
const start = series(compile, serve)

module.exports = {
  lint,
  compile,
  serve,
  build,
  clean,
  start,
}
```





## 自动化部署

### 1.安装依赖

```cmd
// 1. 全局安装 gulp 和 gulp-sftp：
npm i --global gulp
npm i --global gulp-sftp
 
// 2. 作为项目的开发依赖（devDependencies）安装：
npm i --save-dev gulp-sftp
```



### 2. 创建 upload 任务

**gulp-config.js**

```js
module.exports = {
  // 部署正式服务器上
  devDist: {
    // 部署到服务器的路径
    remotePath: '/ZZC1206/zzc-pages',
    // ip地址
    host: '140.82.114.4',
    // 帐号
    user: '960052730@qq.com',
    // 密码
    pass: 'xxxxxxxxxxx',
    // 端口
    port: 22,
    // 公钥
    key: 'C:/Users/Sharvin/.ssh/id_rsa.pub'
  },
  // 程序编译好路径
  publicPath: '/dist/'
}

```



```js
// 实现这个项目的构建任务
const { src, dest, parallel, series, watch } = require('gulp')

const loadPlugins = require('gulp-load-plugins') // 导入插件自动加载工具
const plugins = loadPlugins()

const browserSync = require('browser-sync') // 导入 browser-sync 插件
const bs = browserSync.create()

const del = require('del') // 导入 del 插件

const ftp = require('gulp-sftp')
const gulpConfig = require('./gulp-config.js');

const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}
// 清除文件
const clean = () => {
  return del(['dist', 'temp'])
}
// 样式构建任务
const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(plugins.sass({ outputStyle: 'expanded' }))// 按照完全展开的格式转换
    .pipe(dest('temp'))
}
// 脚本构建任务
const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(plugins.babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('temp'))
}
// 页面模板构建任务
const page = () => {
  return src('src/*.html', { base: 'src' }) // 假如要装换任意目录下的 .html 文件，'src/**/*.html'
    .pipe(plugins.swig({ data }))
    .pipe(dest('temp'))
}
// 图片构建任务
const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}
// 字体包构建任务
const font = () => {
  return src('src/assets/fonts/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}
// 其他文件构建任务
const extra = () => {
  return src('public/**', { base: 'public' })
    .pipe(dest('dist'))
}
// 开启服务器任务
const serve = () => {
  // 监听的文件路径 文件发生变化后需要执行的构建任务
  watch('src/assets/styles/*.scss', style)
  watch('src/assets/scripts/*.js', script)
  watch('src/*.html', page)
  watch([
    'src/assets/images/**',
    'src/assets/fonts/**',
    'public/**'
  ], bs.reload) // 监听文件变化，重新发送请求

  bs.init({
    notify: false, // 关掉提示
    port: 2080, // 设置端口，端口任意，只要是4位。冲突时改写一次
    livereload: true, // 实时热更新，方便调试。
    // open: false, // 取消自动打开浏览器
    files: 'temp/**', // 需要监听的文件
    server: {
      baseDir: ['temp', 'src', 'public'], // 会根据文件夹依次寻找文件
      routes: {
        '/node_modules': 'node_modules'
      }
    }
  })
}
// 页面模板 src 地址 构建任务
const lint = () => {
  return src('dist/*.html', { base: 'temp' })
    .pipe(plugins.useref({ searchPath: ['temp', '.'] }))
    .pipe(plugins.if(/\.js$/, plugins.uglify()))
    .pipe(plugins.if(/\.css$/, plugins.cleanCss()))
    .pipe(plugins.if(/\.html$/, plugins.htmlmin({
      collapseWhitespace: true, // 压缩html里面的空白符
      minifyCSS: true, // 压缩html里面的style标签内容
      minifyJS: true // 压缩html里面的script标签内容
    })))
    .pipe(dest('dist'))
}
// Git 上传任务
const upload = (callback) => {
  return src('.' + gulpConfig.publicPath + '**')
    .pipe(ftp(Object.assign(gulpConfig.devDist, { callback })))
}

// parallel 同时执行
// series 穿行执行

// 编译任务
const compile = parallel(style, script, page)

// 上线前执行的任务
const build = series(clean, parallel(compile, image, font, extra))

// 开发阶段执行的任务
const start = series(compile, serve)

// 自动部署任务
const deploy = series(build, upload)

module.exports = {
  lint,
  compile,
  serve,
  build,
  clean,
  deploy,
  start,
}

```

​	 执行命令测试

```cmd
gulp deploy
```

🌰

```cmd
PS F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate> gulp deploy
[08:06:11] Using gulpfile F:\lagoufed-e-task\part2\fed-e-task-02-01\code\pages-boilerplate\gulpfile.js
[08:06:11] Starting 'deploy'...
[08:06:11] Starting 'clean'...
[08:06:11] Finished 'clean' after 43 ms
[08:06:11] Starting 'image'...
[08:06:11] Starting 'font'...
[08:06:11] Starting 'extra'...
[08:06:11] Starting 'style'...
[08:06:11] Starting 'script'...
[08:06:11] Starting 'page'...
[08:06:15] Finished 'extra' after 3.68 s
[08:06:15] Finished 'script' after 3.68 s
[08:06:15] gulp-imagemin: Minified 1 image (saved 693 B - 6%)
[08:06:15] Finished 'page' after 3.68 s
[08:06:15] Finished 'style' after 3.69 s
[08:06:15] Finished 'font' after 3.7 s
[08:06:15] gulp-imagemin: Minified 2 images (saved 23.1 kB - 26.7%)
[08:06:15] Finished 'image' after 4.13 s
[08:06:15] Starting 'upload'...
[08:06:15] Authenticating with password.
[08:06:18] 'upload' errored after 3.09 s
[08:06:18] Error in plugin 'gulp-sftp'
Message:
    Authentication failure. Available authentication methods: publickey
Details:
    level: authentication
    partial: false
    domainEmitter: [object Object]
    domainThrown: false
[08:06:18] 'deploy' errored after 7.28 s
```

​		这里报错了，找不到解决办法，能帮忙看看么。



## 问题汇总

### 问题1：Message: gulp-sass 5 does not have a default Sass compiler; please set one yourself.Both the `sass` and `node-sass` packages are permitted.

原因直接执行 **npm i gulp-sass -save-dev** 是直接安装最新版本的 **gulp-sass** 的，可以指定安装低版本

```cmd
npm i gulp-sass@4.0.2 -save-dev
```



### 问题2：Message:  Authentication failure. Available authentication methods: publickey

暂时不会处理